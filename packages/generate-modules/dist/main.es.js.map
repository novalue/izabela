{"version":3,"file":"main.es.js","sources":["../src/main.ts"],"sourcesContent":["import path from 'path'\r\nimport { transformSync } from '@babel/core'\r\nimport { readFileSync, writeFileSync } from 'fs'\r\nimport babelPresetTypescript from '@babel/preset-typescript'\r\nimport babelPluginTransformModulesCommonjs from '@babel/plugin-transform-modules-commonjs'\r\nimport babelPluginTransformModulesUMD from '@babel/plugin-transform-modules-umd'\r\nimport babelPluginTransformModulesAMD from '@babel/plugin-transform-modules-amd'\r\nimport babelPluginTransformModulesSystemjs from '@babel/plugin-transform-modules-systemjs'\r\nimport minimatch from 'minimatch'\r\nimport globby from 'globby'\r\nimport { BabelPluginsParams, Entry, ModuleType } from './types'\r\nimport chokidar from 'chokidar'\r\n\r\nexport * from './types'\r\n\r\nexport const generateModules = (config: {\r\n  watch?: boolean\r\n  entries: Entry[]\r\n}) => {\r\n  const { cwd } = process\r\n  const entries = config.entries\r\n\r\n  const babelPluginsParams: BabelPluginsParams = {\r\n    module: {\r\n      plugin: null,\r\n      ext: '.mjs',\r\n    },\r\n    commonjs: {\r\n      plugin: babelPluginTransformModulesCommonjs,\r\n      ext: '.cjs',\r\n    },\r\n    umd: {\r\n      plugin: babelPluginTransformModulesUMD,\r\n      ext: '.umd.js',\r\n    },\r\n    amd: {\r\n      plugin: babelPluginTransformModulesAMD,\r\n      ext: '.amd.js',\r\n    },\r\n    systemjs: {\r\n      plugin: babelPluginTransformModulesSystemjs,\r\n      ext: '.system.js',\r\n    },\r\n  }\r\n\r\n  const btfs = (path: string): string => {\r\n    return path.replace(/\\\\/g, '/')\r\n  }\r\n\r\n  const transformModules = (filepath: string, { into }: Entry) => {\r\n    try {\r\n      const moduleTypes = typeof into === 'string' ? [into] : into\r\n      const { dir, name, base } = path.parse(filepath)\r\n      const fileContent = readFileSync(filepath, { encoding: 'utf8' })\r\n      Object.entries(babelPluginsParams)\r\n        .filter(([type]) => moduleTypes.includes(type as ModuleType))\r\n        .forEach(([_, { plugin, ext }]) => {\r\n          const transformedFileContent = transformSync(fileContent, {\r\n            presets: [babelPresetTypescript],\r\n            plugins: [plugin].filter(Boolean),\r\n            filename: base,\r\n          })?.code\r\n          const contentWithComments = `/**\r\n * This file is auto-generated by GenerateModulesWebpackPlugin.\r\n * Check this file into source control.\r\n * Do not edit this file.\r\n */\\n${transformedFileContent}\\n/* End of auto-generated content. */\\n`\r\n          writeFileSync(path.join(dir, name) + ext, contentWithComments)\r\n        })\r\n    } catch (e: any) {\r\n      console.error(\r\n        `TransformModulesWebpackPlugin: Couldn't transform module (${filepath}) - ${e.message}`,\r\n      )\r\n    }\r\n  }\r\n\r\n  const transformFile = (filePath: string) => {\r\n    const patternOptions = entries.find(({ pattern }) => {\r\n      const target = btfs(path.resolve(cwd(), filePath))\r\n      const resolvedPattern = btfs(path.resolve(cwd(), pattern))\r\n      return minimatch(target, resolvedPattern)\r\n    })\r\n    if (patternOptions) {\r\n      transformModules(filePath, patternOptions)\r\n    }\r\n  }\r\n  const initialTransform = () =>\r\n    transformFiles(globby.sync(entries.map(({ pattern }) => pattern)))\r\n  const transformFiles = (files: string[]) =>\r\n    files.forEach((file) => transformFile(file))\r\n\r\n  if (config.watch) {\r\n    const watcher = chokidar.watch(\r\n      entries.map(({ pattern }) => pattern),\r\n      {\r\n        ignored: /^\\./,\r\n        cwd: cwd(),\r\n      },\r\n    )\r\n    watcher\r\n      .on('add', (filePath) => transformFile(filePath))\r\n      .on('change', (filePath) => transformFile(filePath))\r\n      .on('ready', () => initialTransform())\r\n  } else {\r\n    initialTransform()\r\n  }\r\n}\r\n"],"names":["generateModules","config","cwd","process","entries","babelPluginsParams","module","plugin","ext","commonjs","babelPluginTransformModulesCommonjs","umd","babelPluginTransformModulesUMD","amd","babelPluginTransformModulesAMD","systemjs","babelPluginTransformModulesSystemjs","btfs","path","replace","transformModules","filepath","into","moduleTypes","dir","name","base","parse","fileContent","readFileSync","encoding","Object","filter","type","includes","forEach","_","_transformSync","transformedFileContent","transformSync","presets","babelPresetTypescript","plugins","Boolean","filename","code","contentWithComments","writeFileSync","join","e","console","error","message","transformFile","filePath","patternOptions","find","pattern","target","resolve","resolvedPattern","minimatch","initialTransform","transformFiles","globby","sync","map","files","file","watch","watcher","chokidar","ignored","on"],"mappings":"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"}